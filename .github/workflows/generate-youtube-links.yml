name: Generate YouTube Links

on:
  push:
    paths:
      - 'metadata.json'
  workflow_dispatch:  # Allow manual trigger
  schedule:
    - cron: '*/10 * * * *'  # Run every 10 minutes

concurrency:
  group: youtube-links-generator
  cancel-in-progress: false

jobs:
  generate-links:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if processing needed
        id: check
        run: |
          # Check if youtube-links.json exists and count entries
          if [ -f youtube-links.json ]; then
            PROCESSED=$(jq 'length' youtube-links.json)
          else
            PROCESSED=0
          fi

          # Count total tracks in metadata
          TOTAL=$(jq '[.[].tracks // []] | add | length' metadata.json)

          echo "Processed: $PROCESSED / Total: $TOTAL"

          if [ $PROCESSED -lt $TOTAL ]; then
            echo "continue=true" >> $GITHUB_OUTPUT
            echo "Need to process more tracks"
          else
            echo "continue=false" >> $GITHUB_OUTPUT
            echo "All tracks processed!"
          fi

      - name: Set up Python
        if: steps.check.outputs.continue == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.check.outputs.continue == 'true'
        run: |
          pip install yt-dlp requests

      - name: Configure Git
        if: steps.check.outputs.continue == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Generate YouTube links
        if: steps.check.outputs.continue == 'true'
        run: |
          python scripts/fetch_youtube_links.py
